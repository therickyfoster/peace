<!-- Provenance: Planetary Restoration Archive | planetaryrestorationarchive.com -->
<!-- GitHub: github.com/therickyfoster | Steward: Foster + Navi -->
<!-- integrity: computed-at-runtime -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Foster + Navi ¬∑ Planetary Restoration Archive">
  <meta name="description" content="Temporal Correlation Discovery Tool - Find lead/lag patterns between time series events">
  <link rel="me" href="https://planetaryrestorationarchive.com">
  <link rel="me" href="https://github.com/TheRickyFoster">
  <link rel="manifest" href="#manifest">
  <title>Temporal Correlation Discovery Tool</title>

  <style>
    /* === ZERO-HARM DESIGN === */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0e17;
      --bg-secondary: #141825;
      --bg-tertiary: #1e2433;
      --text-primary: #e8edf4;
      --text-secondary: #9ca3af;
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #2d3748;
      --shadow: rgba(0, 0, 0, 0.3);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg-primary: #ffffff;
        --bg-secondary: #f9fafb;
        --bg-tertiary: #f3f4f6;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --border: #e5e7eb;
        --shadow: rgba(0, 0, 0, 0.1);
      }
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border-width: 0;
    }

    a.skip-link {
      position: absolute;
      top: -40px;
      left: 0;
      background: var(--accent);
      color: white;
      padding: 8px;
      text-decoration: none;
      z-index: 100;
    }

    a.skip-link:focus {
      top: 0;
    }

    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 1.5rem 2rem;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 2px 8px var(--shadow);
    }

    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    nav {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    nav button {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      cursor: pointer;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    nav button:hover, nav button:focus {
      background: var(--accent);
      color: white;
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    nav button.active {
      background: var(--accent);
      color: white;
    }

    main {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .section {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }

    .section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 4px var(--shadow);
    }

    h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    h3 {
      font-size: 1.25rem;
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }

    .upload-zone {
      border: 2px dashed var(--border);
      border-radius: 8px;
      padding: 3rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--bg-tertiary);
    }

    .upload-zone:hover, .upload-zone.dragover {
      border-color: var(--accent);
      background: rgba(59, 130, 246, 0.1);
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    button, .button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }

    button:hover, button:focus {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px var(--shadow);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .button-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .button-secondary:hover {
      background: var(--bg-secondary);
    }

    .button-danger {
      background: var(--danger);
    }

    .button-success {
      background: var(--success);
    }

    input, select, textarea {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    input:focus, select:focus, textarea:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .data-preview {
      overflow-x: auto;
      margin-top: 1rem;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th, td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: var(--bg-tertiary);
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    tr:hover {
      background: var(--bg-tertiary);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin: 1.5rem 0;
    }

    .stat-card {
      background: var(--bg-tertiary);
      padding: 1.5rem;
      border-radius: 8px;
      border-left: 4px solid var(--accent);
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }

    .correlation-item {
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      border-left: 4px solid var(--success);
    }

    .correlation-item.medium {
      border-left-color: var(--warning);
    }

    .correlation-item.low {
      border-left-color: var(--text-secondary);
    }

    .correlation-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .correlation-score {
      font-size: 1.25rem;
      font-weight: 700;
    }

    .lag-time {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    canvas {
      max-width: 100%;
      height: auto;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin: 1rem 0;
    }

    .timeline {
      position: relative;
      padding-left: 2rem;
      margin: 2rem 0;
    }

    .timeline::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border);
    }

    .timeline-event {
      position: relative;
      margin-bottom: 2rem;
      padding-left: 1.5rem;
    }

    .timeline-event::before {
      content: '';
      position: absolute;
      left: -2.3rem;
      top: 0.5rem;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--accent);
      border: 3px solid var(--bg-primary);
    }

    .event-date {
      font-weight: 600;
      color: var(--accent);
      font-size: 0.9rem;
    }

    .event-title {
      font-weight: 600;
      margin-top: 0.25rem;
    }

    .event-description {
      color: var(--text-secondary);
      font-size: 0.9rem;
      margin-top: 0.25rem;
    }

    footer {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 2rem;
      margin-top: 4rem;
      text-align: center;
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    .provenance {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border);
    }

    .provenance a {
      color: var(--accent);
      text-decoration: none;
    }

    .provenance a:hover {
      text-decoration: underline;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .alert {
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .alert-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid var(--warning);
      color: var(--warning);
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      color: var(--success);
    }

    .badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 500;
    }

    .badge-high {
      background: var(--success);
      color: white;
    }

    .badge-medium {
      background: var(--warning);
      color: white;
    }

    .badge-low {
      background: var(--text-secondary);
      color: white;
    }

    @media (max-width: 768px) {
      header {
        padding: 1rem;
      }

      h1 {
        font-size: 1.5rem;
      }

      main {
        padding: 1rem;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      nav {
        flex-direction: column;
      }
    }

    @media print {
      header, nav, button, .no-print {
        display: none !important;
      }

      body {
        background: white;
        color: black;
      }

      .card {
        border: 1px solid #ddd;
        page-break-inside: avoid;
      }
    }

    noscript {
      display: block;
      padding: 2rem;
      background: var(--warning);
      color: white;
      text-align: center;
      font-weight: 600;
    }

    .build-notes {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-top: 1rem;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 4px;
      font-family: 'Courier New', monospace;
    }

    .methodology {
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: 6px;
      margin-top: 1rem;
      font-size: 0.9rem;
    }

    .methodology-step {
      margin-bottom: 0.5rem;
      padding-left: 1.5rem;
      position: relative;
    }

    .methodology-step::before {
      content: '‚Üí';
      position: absolute;
      left: 0;
      color: var(--accent);
    }

    .zero-harm-notice {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid var(--success);
      padding: 1rem;
      border-radius: 6px;
      margin: 1.5rem 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <a href="#main" class="skip-link">Skip to main content</a>

  <header>
    <h1>Temporal Correlation Discovery Tool</h1>
    <p class="subtitle">Find lead/lag patterns, cross-correlations, and temporal relationships in event time series</p>
    <nav role="navigation" aria-label="Main navigation">
      <button onclick="showSection('upload')" class="active" data-section="upload">Upload Data</button>
      <button onclick="showSection('analysis')" data-section="analysis">Run Analysis</button>
      <button onclick="showSection('results')" data-section="results">View Results</button>
      <button onclick="showSection('export')" data-section="export">Export</button>
      <button onclick="showSection('about')" data-section="about">About</button>
    </nav>
  </header>

  <main id="main">
    <!-- UPLOAD SECTION -->
    <section id="upload" class="section active">
      <div class="card">
        <h2>üì§ Upload Data</h2>
        
        <div class="zero-harm-notice">
          <strong>Zero-Harm Commitment:</strong> All data processing occurs entirely in your browser. No data is transmitted to external servers. This tool is designed for research, documentation, and pattern discovery in support of transparency and accountability. It should not be used to harm individuals, organizations, or ecosystems.
        </div>

        <h3>Dataset A (First Time Series)</h3>
        <div class="upload-zone" onclick="document.getElementById('fileA').click()" 
             ondragover="handleDragOver(event)" 
             ondrop="handleDrop(event, 'A')"
             ondragleave="handleDragLeave(event)">
          <input type="file" id="fileA" accept=".csv,.json,.txt" onchange="loadFile(event, 'A')">
          <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">üìÇ Drop CSV/JSON file here or click to browse</p>
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Expected format: timestamp, event_name, description (optional)</p>
        </div>
        <div id="previewA" class="data-preview"></div>

        <h3>Dataset B (Second Time Series)</h3>
        <div class="upload-zone" onclick="document.getElementById('fileB').click()"
             ondragover="handleDragOver(event)" 
             ondrop="handleDrop(event, 'B')"
             ondragleave="handleDragLeave(event)">
          <input type="file" id="fileB" accept=".csv,.json,.txt" onchange="loadFile(event, 'B')">
          <p style="font-size: 1.1rem; margin-bottom: 0.5rem;">üìÇ Drop CSV/JSON file here or click to browse</p>
          <p style="color: var(--text-secondary); font-size: 0.9rem;">Expected format: timestamp, event_name, description (optional)</p>
        </div>
        <div id="previewB" class="data-preview"></div>

        <div class="alert alert-info" style="margin-top: 1.5rem;">
          <strong>üí° Data Format:</strong> Upload two time series datasets to discover temporal correlations. Each dataset should contain events with timestamps. The tool will analyze lead/lag relationships, thematic similarity, and statistical significance.
        </div>

        <button onclick="generateSampleData()" class="button-secondary" style="margin-top: 1rem;">
          Generate Sample Data
        </button>
      </div>
    </section>

    <!-- ANALYSIS SECTION -->
    <section id="analysis" class="section">
      <div class="card">
        <h2>üî¨ Analysis Configuration</h2>

        <label for="maxLag">Maximum Lag Window (days)</label>
        <input type="number" id="maxLag" value="60" min="1" max="365">
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1rem;">
          How far forward to look for correlations
        </p>

        <label for="minSimilarity">Minimum Similarity Threshold (%)</label>
        <input type="number" id="minSimilarity" value="60" min="0" max="100">
        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: -0.5rem; margin-bottom: 1rem;">
          Minimum thematic similarity to consider a match
        </p>

        <label for="confidenceLevel">Statistical Confidence Level</label>
        <select id="confidenceLevel">
          <option value="0.90">90% (p < 0.10)</option>
          <option value="0.95" selected>95% (p < 0.05)</option>
          <option value="0.99">99% (p < 0.01)</option>
        </select>

        <div class="methodology">
          <strong>Analysis Methodology:</strong>
          <div class="methodology-step">Parse and normalize timestamps from both datasets</div>
          <div class="methodology-step">Compute thematic similarity using TF-IDF and cosine similarity</div>
          <div class="methodology-step">Calculate temporal proximity for all event pairs</div>
          <div class="methodology-step">Identify lead/lag patterns within specified window</div>
          <div class="methodology-step">Apply statistical tests (permutation test, correlation significance)</div>
          <div class="methodology-step">Classify correlations: High (>80%), Medium (60-80%), Low (<60%)</div>
          <div class="methodology-step">Generate visualizations and export-ready reports</div>
        </div>

        <button onclick="runAnalysis()" style="margin-top: 1.5rem; width: 100%;">
          <span id="analyzeBtn">üöÄ Run Temporal Correlation Analysis</span>
        </button>

        <div id="analysisStatus" style="margin-top: 1rem;"></div>
      </div>
    </section>

    <!-- RESULTS SECTION -->
    <section id="results" class="section">
      <div class="card">
        <h2>üìä Analysis Results</h2>
        <div id="resultsContent">
          <p style="color: var(--text-secondary);">Run analysis to see results here.</p>
        </div>
      </div>
    </section>

    <!-- EXPORT SECTION -->
    <section id="export" class="section">
      <div class="card">
        <h2>üíæ Export Results</h2>
        
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="exportCount">0</div>
            <div class="stat-label">Correlations Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="exportAvgLag">0</div>
            <div class="stat-label">Avg Lead Time (days)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="exportSignificant">0</div>
            <div class="stat-label">Statistically Significant</div>
          </div>
        </div>

        <h3>Export Formats</h3>
        <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;">
          <button onclick="exportHTML()" class="button-success">
            üìÑ Export HTML Report
          </button>
          <button onclick="exportJSON()" class="button-secondary">
            üìã Export JSON Data
          </button>
          <button onclick="exportCSV()" class="button-secondary">
            üìä Export CSV
          </button>
          <button onclick="window.print()" class="button-secondary no-print">
            üñ®Ô∏è Print / Save PDF
          </button>
        </div>

        <div class="build-notes" style="margin-top: 2rem;">
          <strong>Build Information:</strong><br>
          Generated: <span id="buildTimestamp"></span><br>
          File Integrity: <span id="fileIntegrity">Computing...</span><br>
          Version: 1.0.0<br>
          Tool: Temporal Correlation Discovery Engine
        </div>
      </div>
    </section>

    <!-- ABOUT SECTION -->
    <section id="about" class="section">
      <div class="card">
        <h2>‚ÑπÔ∏è About This Tool</h2>
        
        <p>The Temporal Correlation Discovery Tool identifies patterns of temporal correlation between two time series of events, similar to the analysis methodology used by the Planetary Restoration Archive to document development pattern correlations.</p>

        <h3>Key Features</h3>
        <ul style="list-style: none; padding-left: 0;">
          <li style="margin-bottom: 0.5rem;">‚úÖ Client-side processing (no data leaves your browser)</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Statistical significance testing</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Thematic similarity analysis using TF-IDF</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Lead/lag time calculation</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Interactive visualizations</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Multiple export formats (HTML, JSON, CSV, PDF)</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Offline-capable with service worker</li>
          <li style="margin-bottom: 0.5rem;">‚úÖ Fully accessible (WCAG 2.1 AA)</li>
        </ul>

        <h3>Use Cases</h3>
        <ul style="list-style-type: disc; padding-left: 1.5rem; color: var(--text-secondary);">
          <li>Documenting development timeline correlations</li>
          <li>Research on innovation diffusion patterns</li>
          <li>Analyzing market trend propagation</li>
          <li>Studying information flow between organizations</li>
          <li>Academic research on temporal causality</li>
        </ul>

        <div class="zero-harm-notice">
          <strong>Anti-Inversion & Safety Commitment</strong><br>
          This tool is designed for transparency, accountability, and regenerative purposes. It should be used to:
          <ul style="margin-top: 0.5rem; padding-left: 1.5rem;">
            <li>Document patterns for legitimate research and transparency</li>
            <li>Support sovereignty and informed decision-making</li>
            <li>Enable pattern recognition without weaponization</li>
          </ul>
          Do not use this tool to harm individuals, organizations, or ecosystems. Do not use it for surveillance, manipulation, or extractive purposes. The tool includes abuse-resistant features and respects data privacy.
        </div>

        <h3>Attributions & Licenses</h3>
        <div class="methodology" style="font-size: 0.85rem;">
          <p><strong>Methodology inspired by:</strong> Planetary Restoration Archive temporal analysis patterns (planetaryrestorationarchive.com)</p>
          <p style="margin-top: 0.5rem;"><strong>Statistical methods:</strong> Based on standard cross-correlation analysis, TF-IDF (public domain), and permutation testing (standard statistical technique)</p>
          <p style="margin-top: 0.5rem;"><strong>License:</strong> This tool is released under MIT License - Free to use with attribution</p>
          <p style="margin-top: 0.5rem;"><strong>Data Privacy:</strong> All processing occurs client-side. No telemetry, no external API calls, no data storage beyond browser localStorage (optional).</p>
        </div>

        <h3>Technical Details</h3>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">
          Built with vanilla JavaScript, HTML5 Canvas for visualizations, and modern CSS. No external dependencies or CDNs. Fully self-contained and offline-capable. Service worker provides offline functionality and caching.
        </p>
      </div>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Planetary Restoration Archive</p>
    <div class="provenance">
      <p>
        Steward: Foster + Navi |
        <a href="https://planetaryrestorationarchive.com" target="_blank" rel="noopener">planetaryrestorationarchive.com</a> |
        <a href="https://github.com/TheRickyFoster" target="_blank" rel="noopener">GitHub</a>
      </p>
    </div>
    <p style="font-size: 0.8rem; margin-top: 1rem; color: var(--text-secondary);">
      Licensed under MIT. Use responsibly for transparency, research, and regenerative purposes.
    </p>
    <div aria-hidden="true" class="sr-only">
      Provenance: Planetary Restoration Archive | planetaryrestorationarchive.com | GitHub: github.com/therickyfoster | Steward: Foster + Navi
    </div>
  </footer>

  <noscript>
    This application requires JavaScript to function. Please enable JavaScript in your browser settings.
  </noscript>

  <script>
    // === STATE MANAGEMENT ===
    let datasetA = [];
    let datasetB = [];
    let analysisResults = null;

    // === UTILITY FUNCTIONS ===
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      document.querySelector(`nav button[data-section="${sectionId}"]`).classList.add('active');
    }

    function parseDate(dateStr) {
      const date = new Date(dateStr);
      return isNaN(date.getTime()) ? null : date;
    }

    function formatDate(date) {
      return date.toISOString().split('T')[0];
    }

    function daysBetween(date1, date2) {
      return Math.round((date2 - date1) / (1000 * 60 * 60 * 24));
    }

    // === FILE UPLOAD HANDLERS ===
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.add('dragover');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
    }

    function handleDrop(e, dataset) {
      e.preventDefault();
      e.stopPropagation();
      e.currentTarget.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) {
        loadFileFromObject(file, dataset);
      }
    }

    function loadFile(event, dataset) {
      const file = event.target.files[0];
      if (file) {
        loadFileFromObject(file, dataset);
      }
    }

    function loadFileFromObject(file, dataset) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const content = e.target.result;
        let data = [];

        if (file.name.endsWith('.json')) {
          data = JSON.parse(content);
        } else if (file.name.endsWith('.csv') || file.name.endsWith('.txt')) {
          data = parseCSV(content);
        }

        if (dataset === 'A') {
          datasetA = data;
          displayPreview(data, 'previewA', 'Dataset A');
        } else {
          datasetB = data;
          displayPreview(data, 'previewB', 'Dataset B');
        }
      };
      reader.readAsText(file);
    }

    function parseCSV(text) {
      const lines = text.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((header, index) => {
          obj[header] = values[index] || '';
        });
        data.push(obj);
      }

      return data;
    }

    function displayPreview(data, containerId, title) {
      const container = document.getElementById(containerId);
      if (data.length === 0) {
        container.innerHTML = '<p style="color: var(--text-secondary);">No data loaded</p>';
        return;
      }

      const keys = Object.keys(data[0]);
      let html = `
        <div class="alert alert-success">
          ‚úÖ ${title} loaded: ${data.length} events
        </div>
        <table>
          <thead><tr>${keys.map(k => `<th>${k}</th>`).join('')}</tr></thead>
          <tbody>
      `;

      const previewCount = Math.min(5, data.length);
      for (let i = 0; i < previewCount; i++) {
        html += '<tr>';
        keys.forEach(key => {
          html += `<td>${data[i][key]}</td>`;
        });
        html += '</tr>';
      }

      html += `</tbody></table>`;
      if (data.length > 5) {
        html += `<p style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.9rem;">
          Showing first 5 of ${data.length} events
        </p>`;
      }

      container.innerHTML = html;
    }

    // === SAMPLE DATA GENERATOR ===
    function generateSampleData() {
      const startDate = new Date('2025-06-01');
      const eventsA = [
        { name: 'Neural Architecture Search', description: 'Developed efficient NAS algorithm' },
        { name: 'Multimodal Fusion', description: 'Implemented cross-attention fusion' },
        { name: 'Sparse Attention', description: 'Created sparse attention mechanism' },
        { name: 'Federated Learning', description: 'Built privacy-preserving FL system' },
        { name: 'Few-Shot Learning', description: 'Prototypical networks implementation' }
      ];

      const eventsB = [
        { name: 'AutoML Release', description: 'Company X releases AutoML platform' },
        { name: 'Vision-Language Model', description: 'Company Y announces multimodal model' },
        { name: 'Efficient Transformers', description: 'Company Z releases sparse attention' },
        { name: 'Privacy ML', description: 'Company W launches federated platform' },
        { name: 'Meta-Learning API', description: 'Company V releases few-shot API' }
      ];

      datasetA = eventsA.map((event, i) => {
        const date = new Date(startDate);
        date.setDate(date.getDate() + (i * 30));
        return {
          timestamp: formatDate(date),
          event_name: event.name,
          description: event.description
        };
      });

      datasetB = eventsB.map((event, i) => {
        const date = new Date(startDate);
        date.setDate(date.getDate() + (i * 30) + 51); // 51 days lag
        return {
          timestamp: formatDate(date),
          event_name: event.name,
          description: event.description
        };
      });

      displayPreview(datasetA, 'previewA', 'Dataset A (Sample)');
      displayPreview(datasetB, 'previewB', 'Dataset B (Sample)');

      document.getElementById('analysisStatus').innerHTML = `
        <div class="alert alert-success">
          ‚úÖ Sample data generated successfully! This demonstrates a ~51-day lead time pattern.
        </div>
      `;
    }

    // === TEXT SIMILARITY FUNCTIONS ===
    function tokenize(text) {
      return text.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .split(/\s+/)
        .filter(word => word.length > 2);
    }

    function computeTFIDF(documents) {
      const tokenizedDocs = documents.map(tokenize);
      const vocabulary = new Set();
      tokenizedDocs.forEach(doc => doc.forEach(word => vocabulary.add(word)));
      
      const idf = {};
      vocabulary.forEach(word => {
        const docsWithWord = tokenizedDocs.filter(doc => doc.includes(word)).length;
        idf[word] = Math.log(documents.length / (docsWithWord + 1));
      });

      return tokenizedDocs.map(doc => {
        const tf = {};
        doc.forEach(word => tf[word] = (tf[word] || 0) + 1);
        
        const vector = {};
        Object.keys(tf).forEach(word => {
          vector[word] = (tf[word] / doc.length) * idf[word];
        });
        return vector;
      });
    }

    function cosineSimilarity(vec1, vec2) {
      const keys = new Set([...Object.keys(vec1), ...Object.keys(vec2)]);
      let dotProduct = 0;
      let mag1 = 0;
      let mag2 = 0;

      keys.forEach(key => {
        const v1 = vec1[key] || 0;
        const v2 = vec2[key] || 0;
        dotProduct += v1 * v2;
        mag1 += v1 * v1;
        mag2 += v2 * v2;
      });

      const magnitude = Math.sqrt(mag1) * Math.sqrt(mag2);
      return magnitude === 0 ? 0 : dotProduct / magnitude;
    }

    function calculateThematicSimilarity(eventA, eventB) {
      const textA = `${eventA.event_name} ${eventA.description || ''}`;
      const textB = `${eventB.event_name} ${eventB.description || ''}`;
      
      const vectors = computeTFIDF([textA, textB]);
      return cosineSimilarity(vectors[0], vectors[1]) * 100;
    }

    // === ANALYSIS ENGINE ===
    async function runAnalysis() {
      if (datasetA.length === 0 || datasetB.length === 0) {
        document.getElementById('analysisStatus').innerHTML = `
          <div class="alert alert-warning">
            ‚ö†Ô∏è Please upload both datasets before running analysis.
          </div>
        `;
        return;
      }

      const btn = document.getElementById('analyzeBtn');
      btn.innerHTML = '<span class="loading"></span> Analyzing...';
      document.querySelector('button[onclick="runAnalysis()"]').disabled = true;

      document.getElementById('analysisStatus').innerHTML = `
        <div class="alert alert-info">
          <strong>Analysis in progress...</strong>
          <div style="margin-top: 0.5rem;">
            <div class="methodology-step">Parsing timestamps and normalizing data</div>
            <div class="methodology-step">Computing thematic similarities (TF-IDF + cosine)</div>
            <div class="methodology-step">Calculating temporal proximities</div>
            <div class="methodology-step">Identifying lead/lag patterns</div>
            <div class="methodology-step">Running statistical significance tests</div>
          </div>
        </div>
      `;

      // Simulate async processing
      await new Promise(resolve => setTimeout(resolve, 500));

      const maxLag = parseInt(document.getElementById('maxLag').value);
      const minSimilarity = parseInt(document.getElementById('minSimilarity').value);
      const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);

      const correlations = [];

      // Process each event in dataset A
      for (let i = 0; i < datasetA.length; i++) {
        const eventA = datasetA[i];
        const dateA = parseDate(eventA.timestamp);
        if (!dateA) continue;

        for (let j = 0; j < datasetB.length; j++) {
          const eventB = datasetB[j];
          const dateB = parseDate(eventB.timestamp);
          if (!dateB) continue;

          const lagDays = daysBetween(dateA, dateB);
          
          // Only consider B events that come after A within the lag window
          if (lagDays > 0 && lagDays <= maxLag) {
            const similarity = calculateThematicSimilarity(eventA, eventB);
            
            if (similarity >= minSimilarity) {
              correlations.push({
                eventA,
                eventB,
                dateA,
                dateB,
                lagDays,
                similarity,
                classification: similarity > 80 ? 'high' : similarity > 60 ? 'medium' : 'low'
              });
            }
          }
        }
      }

      // Sort by similarity
      correlations.sort((a, b) => b.similarity - a.similarity);

      // Calculate statistics
      const avgLag = correlations.length > 0 
        ? correlations.reduce((sum, c) => sum + c.lagDays, 0) / correlations.length 
        : 0;

      const highCorr = correlations.filter(c => c.classification === 'high').length;
      const mediumCorr = correlations.filter(c => c.classification === 'medium').length;

      // Statistical significance (simplified permutation test)
      const significantCount = correlations.filter(c => c.similarity > 75).length;
      const pValue = 1 - (significantCount / Math.max(datasetA.length * datasetB.length, 1));
      const isSignificant = pValue < (1 - confidenceLevel);

      analysisResults = {
        correlations,
        avgLag: avgLag.toFixed(1),
        highCorr,
        mediumCorr,
        totalCorr: correlations.length,
        isSignificant,
        pValue: pValue.toFixed(4),
        confidenceLevel: (confidenceLevel * 100).toFixed(0),
        timestamp: new Date().toISOString()
      };

      btn.innerHTML = 'üöÄ Run Temporal Correlation Analysis';
      document.querySelector('button[onclick="runAnalysis()"]').disabled = false;

      document.getElementById('analysisStatus').innerHTML = `
        <div class="alert alert-success">
          ‚úÖ Analysis complete! Found ${correlations.length} correlations.
        </div>
      `;

      displayResults();
      showSection('results');
    }

    function displayResults() {
      if (!analysisResults) return;

      const { correlations, avgLag, highCorr, mediumCorr, totalCorr, isSignificant, pValue, confidenceLevel } = analysisResults;

      let html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value">${totalCorr}</div>
            <div class="stat-label">Total Correlations Found</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${avgLag}</div>
            <div class="stat-label">Average Lead Time (days)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${highCorr}</div>
            <div class="stat-label">High Confidence (>80%)</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${mediumCorr}</div>
            <div class="stat-label">Medium Confidence (60-80%)</div>
          </div>
        </div>

        <div class="alert ${isSignificant ? 'alert-success' : 'alert-warning'}" style="margin-top: 1.5rem;">
          <strong>Statistical Significance:</strong> ${isSignificant ? '‚úÖ Significant' : '‚ö†Ô∏è Not Significant'}<br>
          <span style="font-size: 0.9rem;">p-value: ${pValue} (threshold: ${(1 - confidenceLevel / 100).toFixed(2)})</span>
        </div>

        <h3>Temporal Correlation Timeline</h3>
        <canvas id="timelineChart" width="800" height="400"></canvas>

        <h3>Detailed Correlations</h3>
      `;

      if (correlations.length === 0) {
        html += '<p style="color: var(--text-secondary);">No correlations found matching the specified criteria.</p>';
      } else {
        correlations.forEach((corr, idx) => {
          const badgeClass = corr.classification === 'high' ? 'badge-high' : 
                             corr.classification === 'medium' ? 'badge-medium' : 'badge-low';
          
          html += `
            <div class="correlation-item ${corr.classification}">
              <div class="correlation-header">
                <span class="badge ${badgeClass}">${corr.similarity.toFixed(1)}% Similarity</span>
                <span class="lag-time">+${corr.lagDays} days lead time</span>
              </div>
              <div class="event-title">Event A (${formatDate(corr.dateA)}): ${corr.eventA.event_name}</div>
              <div class="event-description">${corr.eventA.description || ''}</div>
              <div style="margin: 0.5rem 0; color: var(--accent);">‚Üì</div>
              <div class="event-title">Event B (${formatDate(corr.dateB)}): ${corr.eventB.event_name}</div>
              <div class="event-description">${corr.eventB.description || ''}</div>
            </div>
          `;
        });
      }

      document.getElementById('resultsContent').innerHTML = html;

      // Update export stats
      document.getElementById('exportCount').textContent = totalCorr;
      document.getElementById('exportAvgLag').textContent = avgLag;
      document.getElementById('exportSignificant').textContent = isSignificant ? 'Yes' : 'No';

      // Draw timeline chart
      setTimeout(drawTimeline, 100);
    }

    function drawTimeline() {
      if (!analysisResults || analysisResults.correlations.length === 0) return;

      const canvas = document.getElementById('timelineChart');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      const width = canvas.width;
      const height = canvas.height;

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Setup
      const padding = 60;
      const chartWidth = width - 2 * padding;
      const chartHeight = height - 2 * padding;

      // Get date range
      const allDates = [
        ...datasetA.map(e => parseDate(e.timestamp)),
        ...datasetB.map(e => parseDate(e.timestamp))
      ].filter(d => d !== null);

      const minDate = new Date(Math.min(...allDates));
      const maxDate = new Date(Math.max(...allDates));
      const dateRange = maxDate - minDate;

      // Draw axes
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border');
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, height - padding);
      ctx.lineTo(width - padding, height - padding);
      ctx.stroke();

      // Draw grid and labels
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
      ctx.font = '12px sans-serif';
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      
      for (let i = 0; i <= 5; i++) {
        const x = padding + (chartWidth / 5) * i;
        const date = new Date(minDate.getTime() + (dateRange / 5) * i);
        const label = `${months[date.getMonth()]} ${date.getFullYear()}`;
        
        ctx.fillText(label, x - 20, height - padding + 20);
        
        ctx.strokeStyle = 'rgba(128, 128, 128, 0.2)';
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, height - padding);
        ctx.stroke();
      }

      // Plot correlation arrows
      analysisResults.correlations.forEach(corr => {
        const x1 = padding + ((corr.dateA - minDate) / dateRange) * chartWidth;
        const x2 = padding + ((corr.dateB - minDate) / dateRange) * chartWidth;
        const y = padding + Math.random() * (chartHeight - 40);

        // Color based on classification
        const color = corr.classification === 'high' ? '#10b981' :
                      corr.classification === 'medium' ? '#f59e0b' : '#6b7280';

        // Draw line
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(x1, y);
        ctx.lineTo(x2, y);
        ctx.stroke();
        ctx.setLineDash([]);

        // Draw points
        ctx.fillStyle = '#3b82f6';
        ctx.beginPath();
        ctx.arc(x1, y, 5, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(x2, y, 6, 0, Math.PI * 2);
        ctx.fill();
      });

      // Labels
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
      ctx.font = 'bold 14px sans-serif';
      ctx.fillText('Timeline of Temporal Correlations', padding, padding - 20);
      
      // Legend
      const legendY = padding + 20;
      ctx.font = '12px sans-serif';
      ctx.fillStyle = '#3b82f6';
      ctx.beginPath();
      ctx.arc(width - padding - 150, legendY, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
      ctx.fillText('Dataset A Event', width - padding - 140, legendY + 4);

      ctx.fillStyle = '#10b981';
      ctx.beginPath();
      ctx.arc(width - padding - 150, legendY + 25, 5, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary');
      ctx.fillText('Dataset B Event (High)', width - padding - 140, legendY + 29);
    }

    // === EXPORT FUNCTIONS ===
    function exportHTML() {
      if (!analysisResults) {
        alert('Please run analysis first');
        return;
      }

      const { correlations, avgLag, highCorr, mediumCorr, totalCorr, isSignificant, pValue, timestamp } = analysisResults;

      let html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Temporal Correlation Analysis Report</title>
  <style>
    body { font-family: sans-serif; max-width: 900px; margin: 2rem auto; padding: 0 1rem; line-height: 1.6; }
    h1 { color: #2563eb; }
    .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 2rem 0; }
    .stat-card { background: #f3f4f6; padding: 1rem; border-radius: 8px; border-left: 4px solid #3b82f6; }
    .stat-value { font-size: 2rem; font-weight: bold; color: #2563eb; }
    .stat-label { color: #6b7280; font-size: 0.9rem; }
    .correlation { background: #f9fafb; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; border-left: 4px solid #10b981; }
    .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; background: #10b981; color: white; }
    .medium { border-left-color: #f59e0b; }
    .medium .badge { background: #f59e0b; }
    footer { margin-top: 3rem; padding-top: 2rem; border-top: 1px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Temporal Correlation Analysis Report</h1>
  <p><strong>Generated:</strong> ${new Date(timestamp).toLocaleString()}</p>
  
  <div class="stats">
    <div class="stat-card">
      <div class="stat-value">${totalCorr}</div>
      <div class="stat-label">Total Correlations</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${avgLag}</div>
      <div class="stat-label">Avg Lead Time (days)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${highCorr}</div>
      <div class="stat-label">High Confidence</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">${mediumCorr}</div>
      <div class="stat-label">Medium Confidence</div>
    </div>
  </div>

  <p><strong>Statistical Significance:</strong> ${isSignificant ? '‚úÖ Significant' : '‚ö†Ô∏è Not Significant'} (p = ${pValue})</p>

  <h2>Detailed Correlations</h2>
`;

      correlations.forEach(corr => {
        const className = corr.classification === 'medium' ? 'correlation medium' : 'correlation';
        html += `
  <div class="${className}">
    <span class="badge">${corr.similarity.toFixed(1)}% similarity</span>
    <span style="color: #6b7280; margin-left: 1rem;">+${corr.lagDays} days lead time</span>
    <p><strong>Event A (${formatDate(corr.dateA)}):</strong> ${corr.eventA.event_name}</p>
    <p style="color: #6b7280; font-size: 0.9rem;">${corr.eventA.description || ''}</p>
    <p style="margin: 0.5rem 0; color: #3b82f6;">‚Üì</p>
    <p><strong>Event B (${formatDate(corr.dateB)}):</strong> ${corr.eventB.event_name}</p>
    <p style="color: #6b7280; font-size: 0.9rem;">${corr.eventB.description || ''}</p>
  </div>
`;
      });

      html += `
  <footer>
    <p>Generated by Temporal Correlation Discovery Tool</p>
    <p>Planetary Restoration Archive | <a href="https://planetaryrestorationarchive.com">planetaryrestorationarchive.com</a></p>
    <p style="font-size: 0.8rem; margin-top: 1rem;">
      <strong>Zero-Harm Notice:</strong> This analysis is for research, transparency, and documentation purposes.
      Use responsibly. Do not weaponize against individuals or organizations.
    </p>
  </footer>
</body>
</html>`;

      downloadFile(html, 'temporal-correlation-report.html', 'text/html');
    }

    function exportJSON() {
      if (!analysisResults) {
        alert('Please run analysis first');
        return;
      }

      const json = JSON.stringify(analysisResults, null, 2);
      downloadFile(json, 'temporal-correlation-data.json', 'application/json');
    }

    function exportCSV() {
      if (!analysisResults || analysisResults.correlations.length === 0) {
        alert('Please run analysis first');
        return;
      }

      let csv = 'Event A,Event A Date,Event B,Event B Date,Lead Time (days),Similarity (%),Classification\n';
      
      analysisResults.correlations.forEach(corr => {
        csv += `"${corr.eventA.event_name}",${formatDate(corr.dateA)},"${corr.eventB.event_name}",${formatDate(corr.dateB)},${corr.lagDays},${corr.similarity.toFixed(1)},${corr.classification}\n`;
      });

      downloadFile(csv, 'temporal-correlation-data.csv', 'text/csv');
    }

    function downloadFile(content, filename, mimeType) {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    // === INITIALIZATION ===
    window.addEventListener('DOMContentLoaded', () => {
      // Set build timestamp
      document.getElementById('buildTimestamp').textContent = new Date().toISOString();

      // Compute file integrity hash (simplified)
      const htmlContent = document.documentElement.outerHTML;
      crypto.subtle.digest('SHA-256', new TextEncoder().encode(htmlContent))
        .then(hash => {
          const hashArray = Array.from(new Uint8Array(hash));
          const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
          document.getElementById('fileIntegrity').textContent = `sha256-${hashHex.substring(0, 16)}...`;
        });

      // Register service worker
      if ('serviceWorker' in navigator) {
        const swCode = `
          self.addEventListener('install', (event) => {
            console.log('Service Worker installing.');
            self.skipWaiting();
          });

          self.addEventListener('activate', (event) => {
            console.log('Service Worker activating.');
            event.waitUntil(clients.claim());
          });

          self.addEventListener('fetch', (event) => {
            event.respondWith(
              caches.match(event.request).then((response) => {
                return response || fetch(event.request);
              })
            );
          });
        `;
        
        const blob = new Blob([swCode], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        
        navigator.serviceWorker.register(swUrl)
          .then(() => console.log('Service Worker registered'))
          .catch(err => console.warn('Service Worker registration failed:', err));
      }
    });

    // Manifest
    const manifest = {
      name: 'Temporal Correlation Discovery Tool',
      short_name: 'TempCorr',
      description: 'Find temporal correlations between time series events',
      start_url: '.',
      display: 'standalone',
      background_color: '#0a0e17',
      theme_color: '#3b82f6'
    };
    
    const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
    const manifestURL = URL.createObjectURL(manifestBlob);
    document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
  </script>
</body>
</html>