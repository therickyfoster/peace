<!doctype html>
<html lang="en" data-app="peace-lab-auto">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Peace Lab — Automated Media Reframe + Regenerative Cookbook (Single File)</title>
<meta name="description" content="Automated engine that scans feeds, detects harmful framings, and generates regenerative rewrites + a living cookbook. Auto-runs while the tab stays open." />
<meta name="theme-color" content="#0f172a" />
<meta name="color-scheme" content="dark light" />
<style>
  :root{
    --bg:#0a0f1c; --card:#111827; --ink:#e5eef9; --muted:#9fb0c6; --ink-weak:#cbd5e1;
    --accent:#34d399; --warm:#f59e0b; --danger:#ef4444; --mystic:#a855f7; --cool:#06b6d4;
    --radius:16px; --gap:1rem; --shadow:0 10px 30px rgba(0,0,0,.35); --maxw:1200px;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#f8fafc; --card:#fff; --ink:#0b1020; --muted:#475569; --ink-weak:#334155; }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";}
  .shell{max-width:var(--maxw);margin:auto;padding:1.25rem}
  .skip{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
  .skip:focus{left:1rem;top:1rem;width:auto;height:auto;background:#fff;color:#000;padding:.5rem .75rem;border-radius:.5rem}

  header.shell{display:flex;align-items:center;justify-content:space-between;gap:1rem}
  .brand{display:flex;align-items:center;gap:.75rem}
  .brand h1{font-size:1.15rem;margin:0}
  nav .btn{margin-left:.5rem}

  .hero{display:grid;gap:2rem;align-items:center}
  .hero-copy .meta{display:flex;flex-wrap:wrap;gap:.5rem;padding:0;margin:.75rem 0}
  .hero-copy .meta li{list-style:none;background:color-mix(in srgb,var(--accent) 15%, transparent); padding:.35rem .6rem;border-radius:999px}
  .cta .btn{margin-right:.5rem}

  .panel{margin-block:2rem}
  .row{display:flex;align-items:center;gap:.6rem;flex-wrap:wrap}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:var(--gap)}

  input,select{padding:.6rem .7rem;border-radius:.6rem;border:1px solid color-mix(in srgb,var(--ink) 20%, transparent);background:transparent;color:var(--ink)}
  input[type="range"]{width:240px}
  select{width:auto}
  textarea{width:100%;min-height:90px;padding:.6rem .7rem;border-radius:.6rem;border:1px solid color-mix(in srgb,var(--ink) 20%, transparent);resize:vertical}

  .btn{--bg:var(--card);--fg:var(--ink);background:var(--bg);color:var(--fg);border:1px solid color-mix(in srgb,var(--ink) 20%, transparent);padding:.6rem .9rem;border-radius:.7rem;cursor:pointer}
  .btn:hover{border-color:color-mix(in srgb,var(--accent) 45%, var(--ink))}
  .btn:focus-visible{outline:3px solid color-mix(in srgb,var(--accent) 60%, transparent);outline-offset:2px}
  .btn-accent{--bg:color-mix(in srgb,var(--accent) 20%, transparent)}
  .btn-ghost{background:transparent}

  .card{background:var(--card);border:1px solid color-mix(in srgb,var(--ink) 12%, transparent);border-radius:var(--radius);box-shadow:var(--shadow);padding:1rem}
  .card header{display:flex;justify-content:space-between;align-items:center;gap:.6rem}
  .card h4{margin:.2rem 0}
  .meta-row{display:flex;flex-wrap:wrap;gap:.5rem;color:var(--muted);font-size:.9rem}
  .badge{padding:.2rem .5rem;border-radius:.5rem;background:color-mix(in srgb,var(--danger) 15%, transparent)}

  .list{margin-top:.5rem;padding-left:1.1rem}
  .list li{margin:.25rem 0}
  .muted{color:var(--muted)}
  footer{border-top:1px dashed color-mix(in srgb,var(--ink) 15%, transparent); margin-top:3rem}
  footer p{margin:1rem 0}

  @media (prefers-reduced-motion:no-preference){
    [data-animate]{animation:rise .7s ease-out both}
    @keyframes rise{from{opacity:.001;transform:translateY(6px)}to{opacity:1;transform:none}}
  }
  @media print{
    nav, #install, #status, #open-settings{display:none!important}
    body{background:#fff;color:#000}
    .card{break-inside:avoid}
  }
</style>
</head>
<body>
<a class="skip" href="#main">Skip to content</a>

<header class="shell" role="banner">
  <div class="brand">
    <svg aria-hidden="true" width="40" height="40" viewBox="0 0 96 96">
      <defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#34d399"/><stop offset="1" stop-color="#06b6d4"/></linearGradient></defs>
    </svg>
    <h1>Peace Lab — Automated Node</h1>
  </div>
  <nav aria-label="Primary">
    <button class="btn" id="scan">Scan Now</button>
    <button class="btn" id="export">Export Ledger</button>
    <button class="btn" id="print">Print</button>
    <button class="btn" id="open-settings">Settings</button>
    <button class="btn" id="install" title="Add to Home Screen">Install</button>
    <span id="status" class="muted" aria-live="polite"></span>
  </nav>
</header>

<main id="main" class="shell">
  <section class="hero" data-animate>
    <div class="hero-copy">
      <h2>Automate reframing while the tab is open.</h2>
      <p>This node scans feeds, detects harmful frames, generates dignity-first rewrites, and updates a living “Regenerative Cookbook.” Leave it open and let it propagate care.</p>
      <ul class="meta"><li>Single file</li><li>WCAG AA+</li><li>Local XML</li><li>IPFS-ready</li></ul>
      <div class="row">
        <label class="file btn btn-ghost" for="xml">Load Local XML</label>
        <input id="xml" type="file" accept=".xml,.rss,.atom,.rdf" hidden />
        <button class="btn btn-accent" id="quickstart">Quick Start</button>
      </div>
    </div>
  </section>

  <section class="panel">
    <h3>Automation & Context</h3>
    <div class="row">
      <label for="city" class="muted">City</label>
      <input id="city" type="text" placeholder="City or region (optional)" />
      <label for="threshold" class="muted">Sensitivity</label>
      <input id="threshold" type="range" min="0" max="100" value="55" />
      <span class="muted" id="th-label">55</span>
      <label for="interval" class="muted">Auto-scan</label>
      <select id="interval">
        <option value="0">Off</option>
        <option value="5">5 min</option>
        <option value="10" selected>10 min</option>
        <option value="30">30 min</option>
        <option value="60">60 min</option>
      </select>
      <label class="muted"><input type="checkbox" id="run-when-hidden" checked /> Run when tab hidden</label>
      <label class="muted"><input type="checkbox" id="auto-export" /> Auto-export after run</label>
    </div>
    <div class="row">
      <input id="new-feed" type="url" placeholder="https://example.com/feed.xml" />
      <button class="btn" id="add-feed">Add Feed</button>
      <button class="btn btn-ghost" id="load-examples">Load Example Feeds</button>
      <button class="btn btn-ghost" id="clear-feeds">Clear Feeds</button>
    </div>
    <ul id="feeds" class="list" aria-live="polite"></ul>
  </section>

  <section class="panel">
    <h3>Reframing Opportunities</h3>
    <div id="results" class="grid" aria-live="polite"></div>
  </section>

  <section class="panel">
    <h3>Regenerative Cookbook (live)</h3>
    <p class="muted">A running “misframe → regenerative rewrite” guide for editors and crews. Expands as rules grow.</p>
    <div id="cookbook" class="grid"></div>
  </section>
</main>

<footer class="shell">
  <p>Peace Lab — Automated Media Reframe · CC-BY-SA 4.0 · <span id="offline">UI ready</span></p>
</footer>

<script type="module">
/* ===============================
   Automated Peace Propagation Node
   Single-file edition with inline SW
   =============================== */

/* ---------- Lexicons & Cookbook ---------- */
const NEGATIVE_LEX = [
  "crisis","violence","surge","wave","spike","chaos","shocking","plague","disaster",
  "crime","homeless problem","vagrant","nuisance","tent city","infestation","war"
];
const DIGNITY_ANTIPATTERNS = [
  "the homeless","illegals","bums","addicts","transients","junkies","vagrants"
];

const COOKBOOK = [
  {
    id:"people-first",
    match: /(^|\\b)(the homeless|bums|vagrants|transients|illegals|junkies)(\\b|$)/i,
    before:"Dehumanizing category terms.",
    after:"Use people-first language (e.g., “people experiencing homelessness,” “undocumented neighbors”).",
    snippetBefore:"City targets 'the homeless' in new policy",
    snippetAfter:"City invests with people experiencing homelessness as partners in policy"
  },
  {
    id:"crime-wave",
    match:/crime wave|spike in crime|crime surge/i,
    before:"Sensational ‘wave’ framing.",
    after:"Describe specific harms, systemic context, and remedies; focus on prevention and repair.",
    snippetBefore:"Downtown faces crime wave as tents grow",
    snippetAfter:"Downtown addresses harm with lighting, warmth access, and consent-first outreach"
  },
  {
    id:"tent-city",
    match:/tent city|encampment/i,
    before:"Derogatory shorthand.",
    after:"Use “survival encampment” and explain constraints (shelter capacity, weather, safety).",
    snippetBefore:"Tent city expands near library",
    snippetAfter:"Survival encampment grows as shelters fill; city opens warmth map and lockers"
  }
];

/* ---------- Helpers ---------- */
const $ = (s,r=document)=>r.querySelector(s);
const $$ = (s,r=document)=>[...r.querySelectorAll(s)];
const clean = s => (s||"").replace(/<[^>]+>/g," ").replace(/\s+/g," ").trim();
const snippet = (s,n)=> s.length>n ? s.slice(0,n-1)+"…" : s;
const escapeHtml = s => (s||"").replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const escapeAttr = escapeHtml;

function scoreNegativity(text){
  const t = (text||"").toLowerCase();
  let hits = 0;
  NEGATIVE_LEX.forEach(w => { if(t.includes(w)) hits++; });
  DIGNITY_ANTIPATTERNS.forEach(w => { if(t.includes(w)) hits += 2; });
  const len = Math.max(30, t.length);
  const raw = Math.min(100, Math.round((hits*14) * (120/len) + hits*4));
  return Math.max(0, raw);
}
function replaceAllIns(s, map){
  let out = s;
  Object.entries(map).forEach(([from,to])=>{
    out = out.replace(new RegExp(from.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi'), to);
  });
  return out;
}
function softenTitle(title){
  return replaceAllIns(title || "Local story", {
    "homeless problem":"neighbors without housing",
    "homeless":"people experiencing homelessness",
    "tent city":"survival encampment",
    "crime wave":"harm trend",
    "drug users":"people who use drugs",
    "addicts":"people in addiction",
    "vagrant":"neighbor",
    "illegal":"undocumented neighbor",
    "illegals":"undocumented neighbors"
  });
}
function loveRewrite({title, city}){
  const softened = softenTitle(title);
  const frames = [
    `From ${softened} to ${city||"our city"}: turning headlines into a repair quest`,
    `${city||"Community"} names its helpers: ${softened} becomes a stewardship trial`,
    `Neighbors, not numbers: reframing ${softened} with love and care`,
    `Debugging the system: ${softened} → open repair, warm spaces, consent-first help`
  ];
  const hed = frames[Math.floor(Math.random()*frames.length)];
  const nutgraf = `In partnership with people with lived experience, ${city||"the community"} is shifting from blame to repair. Goals: warmth, choice, belonging.
- consent-first support replaces surveillance
- repair guild stipends fix benches, lights, ramps
- mutual-aid kitchens + lockers provide dignity infrastructure.`;
  const quests = [
    "SMS warmth map + paper map at libraries",
    "Showers/lockers pilot (library or community center)",
    "Repair guild stipends for quick fixes (lights, benches, ramps)",
    "Kitchen rota with dignity tokens for contributors"
  ];
  return {hed, nutgraf, quests};
}

/* ---------- RSS/Atom ---------- */
async function fetchFeed(url){
  const res = await fetch(url, { mode:"cors" });
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const xml = await res.text();
  return parseXml(xml, url);
}
function parseXml(xmlText, url=""){
  const doc = new DOMParser().parseFromString(xmlText, "application/xml");
  const parsererror = doc.querySelector("parsererror");
  if(parsererror) throw new Error("XML parse error");

  let items = [...doc.querySelectorAll("rss channel item")].map(it => ({
    title: text(it,"title"), link: text(it,"link"), pubDate: text(it,"pubDate"),
    summary: text(it,"description") || text(it,"content\\:encoded"), source: url
  }));
  if(items.length===0){
    items = [...doc.querySelectorAll("feed entry")].map(it => ({
      title: text(it,"title"), link: attr(it,"link","href"),
      pubDate: text(it,"updated") || text(it,"published"),
      summary: text(it,"summary") || text(it,"content"), source: url
    }));
  }
  if(items.length===0){
    items = [...doc.querySelectorAll("rdf\\:RDF item")].map(it => ({
      title: text(it,"title"), link: text(it,"link"),
      pubDate: text(it,"dc\\:date"), summary: text(it,"description"), source: url
    }));
  }
  return items;
}
function text(root, sel){ const el=root.querySelector(sel); return el?(el.textContent||"").trim():""; }
function attr(root, sel, name){ const el=root.querySelector(sel); return el?(el.getAttribute(name)||"").trim():""; }

/* ---------- State ---------- */
const state = {
  feeds: JSON.parse(localStorage.getItem("pla.feeds") || "[]"),
  ledger: JSON.parse(localStorage.getItem("pla.ledger") || "[]"),
  city: localStorage.getItem("pla.city") || "",
  threshold: +(localStorage.getItem("pla.thresh") || 55),
  everyMin: +(localStorage.getItem("pla.interval") || 10),
  runHidden: localStorage.getItem("pla.hidden")==="1",
  autoExport: localStorage.getItem("pla.autoExport")==="1",
  lastRun: null,
  timer: null
};
function savePrefs(){
  localStorage.setItem("pla.feeds", JSON.stringify(state.feeds));
  localStorage.setItem("pla.city", state.city);
  localStorage.setItem("pla.thresh", String(state.threshold));
  localStorage.setItem("pla.interval", String(state.everyMin));
  localStorage.setItem("pla.hidden", state.runHidden ? "1":"0");
  localStorage.setItem("pla.autoExport", state.autoExport ? "1":"0");
}
function pushLedger(entries){
  state.ledger.unshift(...entries);
  if(state.ledger.length>5000) state.ledger.splice(5000);
  localStorage.setItem("pla.ledger", JSON.stringify(state.ledger));
}

/* ---------- UI ---------- */
const statusEl = $("#status");
const results = $("#results");
const cookbook = $("#cookbook");

function renderFeeds(){
  const ul = $("#feeds"); ul.innerHTML="";
  state.feeds.forEach((f,i)=>{
    const li = document.createElement("li");
    li.textContent = f;
    const rm = document.createElement("button");
    rm.className = "btn btn-ghost"; rm.textContent = "Remove";
    rm.addEventListener("click", ()=>{ state.feeds.splice(i,1); savePrefs(); renderFeeds(); });
    li.append(" ", rm);
    ul.appendChild(li);
  });
}
function renderCookbook(){
  cookbook.innerHTML="";
  COOKBOOK.forEach(rule=>{
    const card = document.createElement("article");
    card.className="card";
    card.innerHTML = `
      <header><h4>${rule.id.replace(/-/g," ")}</h4></header>
      <p class="muted">${rule.before}</p>
      <div class="meta-row"><span class="badge">Rewrite</span></div>
      <p><strong>${rule.snippetBefore}</strong><br/>→ ${rule.snippetAfter}</p>
      <p class="muted">Guideline: ${rule.after}</p>
    `;
    cookbook.appendChild(card);
  });
}
function cardForItem(it, score){
  const city = state.city;
  const rw = loveRewrite({title: it.title, city});
  const card = document.createElement("article");
  card.className="card";
  card.innerHTML = `
    <header>
      <h4>${escapeHtml(it.title || "Untitled")}</h4>
      <span class="badge">${score>=80?"High":score>=60?"Medium":"Low"} need</span>
    </header>
    <div class="meta-row">
      <span class="muted">${it.pubDate ? new Date(it.pubDate).toLocaleString() : ""}</span>
      ${it.link ? `<a class="btn btn-ghost" target="_blank" rel="noopener" href="${escapeAttr(it.link)}">Source</a>` : ""}
    </div>
    <p class="muted">${escapeHtml(snippet(clean(it.summary||""), 240))}</p>
    <div class="tools">
      <button class="btn btn-accent">Regenerate</button>
      <button class="btn">Copy</button>
    </div>
    <section class="reframe" aria-live="polite">
      <label class="muted">Regenerative Headline</label>
      <textarea class="hed">${rw.hed}</textarea>
      <label class="muted">Nutgraf (dignity-first)</label>
      <textarea class="nut">${rw.nutgraf}</textarea>
      <label class="muted">Repair Quests</label>
      <textarea class="q">${rw.quests.map(q=>"• "+q).join("\\n")}</textarea>
    </section>
  `;
  const btnGen = card.querySelector(".btn.btn-accent");
  const btnCopy = card.querySelector(".btn:not(.btn-accent)");
  btnGen.addEventListener("click", ()=>{
    const newer = loveRewrite({title: it.title, city});
    card.querySelector(".hed").value = newer.hed;
    card.querySelector(".nut").value = newer.nutgraf;
    card.querySelector(".q").value = newer.quests.map(q=>"• "+q).join("\\n");
  });
  btnCopy.addEventListener("click", async ()=>{
    const txt = [
      `HEADLINE: ${card.querySelector(".hed").value}`, "",
      `NUTGRAF:`, card.querySelector(".nut").value, "",
      `REPAIR QUESTS:`, card.querySelector(".q").value, "",
      `SOURCE: ${it.link||""}`
    ].join("\\n");
    try{ await navigator.clipboard.writeText(txt); btnCopy.textContent="Copied!"; setTimeout(()=>btnCopy.textContent="Copy",1200);}catch{}
  });
  return card;
}

/* ---------- Scan loop ---------- */
async function runScan(reason="manual"){
  if(state.feeds.length===0){ statusEl.textContent="No feeds configured."; return; }
  statusEl.textContent = `Scanning (${reason})…`;
  const start = Date.now();
  const found = [];
  for(const f of state.feeds){
    try{
      const items = await fetchFeed(f);
      found.push(...items);
    }catch(err){
      console.warn("Feed failed", f, err);
      found.push({ title:`(Couldn’t fetch feed) ${f}`, link:f, summary:"CORS or network blocked.", pubDate:"", source:f, _failed:true });
    }
  }
  results.innerHTML = "";
  const threshold = state.threshold;
  const adds = [];
  found.forEach(it=>{
    const score = scoreNegativity(`${it.title} ${clean(it.summary)}`);
    if(score < threshold) return;
    results.appendChild(cardForItem(it, score));
    const rw = loveRewrite({title: it.title, city: state.city});
    adds.push({ ts:new Date().toISOString(), title: it.title, link: it.link, pubDate: it.pubDate, source: it.source,
      negativity: score, city: state.city, hed: rw.hed, nutgraf: rw.nutgraf, quests: rw.quests, reason });
  });
  pushLedger(adds);
  statusEl.textContent = `Scan complete: ${adds.length} opportunities in ${(Date.now()-start)/1000}s.`;
  if(state.autoExport && adds.length){ doExport(true); }
}

function startTimer(){
  stopTimer();
  if(state.everyMin<=0) return;
  state.timer = setInterval(async ()=>{
    if(document.hidden && !state.runHidden) return;
    await runScan("auto");
  }, state.everyMin*60*1000);
}
function stopTimer(){ if(state.timer){ clearInterval(state.timer); state.timer=null; } }

/* ---------- Export ---------- */
function doExport(silent=false){
  const out = { ts:new Date().toISOString(), city: state.city, items: state.ledger.slice(0,500) };
  const blob = new Blob([JSON.stringify(out,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href = url; a.download = `peace-ledger-${Date.now()}.json`; a.click();
  URL.revokeObjectURL(url);
  if(!silent) statusEl.textContent = "Exported current ledger JSON.";
}

/* ---------- Controls ---------- */
$("#quickstart").addEventListener("click", ()=>{
  if(state.feeds.length===0){
    state.feeds = [
      "https://www.theguardian.com/world/rss",
      "https://rss.nytimes.com/services/xml/rss/nyt/World.xml"
    ];
    savePrefs(); renderFeeds();
  }
  runScan("quickstart");
});
$("#xml").addEventListener("change", async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const text = await file.text();
  try{
    const items = parseXml(text, file.name);
    results.innerHTML=""; const adds=[];
    items.forEach(it=>{
      const score = scoreNegativity(`${it.title} ${clean(it.summary)}`);
      if(score < state.threshold) return;
      results.appendChild(cardForItem(it, score));
      const rw = loveRewrite({title: it.title, city: state.city});
      adds.push({ ts:new Date().toISOString(), title: it.title, link: it.link, pubDate: it.pubDate, source:file.name,
        negativity:score, city:state.city, hed:rw.hed, nutgraf:rw.nutgraf, quests:rw.quests, reason:"local-xml" });
    });
    pushLedger(adds);
    statusEl.textContent = `Loaded ${adds.length} opportunities from local XML.`;
  }catch{ statusEl.textContent="Could not parse XML."; }
});
$("#add-feed").addEventListener("click", ()=>{
  const u = $("#new-feed").value.trim(); if(!u) return;
  state.feeds.push(u); $("#new-feed").value=""; savePrefs(); renderFeeds();
});
$("#load-examples").addEventListener("click", ()=>{
  state.feeds = [
    "https://www.ctvnews.ca/rss/ctvnews-ca-top-stories-public-rss-1.822009",
    "https://www.aljazeera.com/xml/rss/all.xml"
  ];
  savePrefs(); renderFeeds();
});
$("#clear-feeds").addEventListener("click", ()=>{ state.feeds=[]; savePrefs(); renderFeeds(); });

$("#scan").addEventListener("click", ()=>runScan("manual"));
$("#export").addEventListener("click", ()=>doExport(false));
$("#print").addEventListener("click", ()=>window.print());

$("#city").value = state.city;
$("#city").addEventListener("input", ()=>{ state.city=$("#city").value.trim(); savePrefs(); });

$("#threshold").value = state.threshold;
$("#th-label").textContent = String(state.threshold);
$("#threshold").addEventListener("input", e=>{ state.threshold=+e.target.value; $("#th-label").textContent=String(state.threshold); savePrefs(); });

$("#interval").value = String(state.everyMin);
$("#interval").addEventListener("change", e=>{ state.everyMin=+e.target.value; savePrefs(); startTimer(); });

$("#run-when-hidden").checked = !!state.runHidden;
$("#run-when-hidden").addEventListener("change", e=>{ state.runHidden = e.target.checked; savePrefs(); });

$("#auto-export").checked = !!state.autoExport;
$("#auto-export").addEventListener("change", e=>{ state.autoExport = e.target.checked; savePrefs(); });

$("#open-settings").addEventListener("click", ()=>document.querySelector("header").scrollIntoView({behavior:"smooth"}));

/* Keyboard shortcuts */
document.addEventListener("keydown",(e)=>{
  if(e.key==="/"){ e.preventDefault(); $("#new-feed").focus(); }
  if(e.key.toLowerCase()==="s"){ e.preventDefault(); runScan("shortcut"); }
  if(e.key.toLowerCase()==="e"){ e.preventDefault(); doExport(false); }
});

/* ---------- Inline Service Worker registration ----------
   Note: Some browsers disallow blob/data URL SW scripts.
   We attempt inline registration; if blocked, we fall back gracefully. */
function registerInlineServiceWorker(){
  if(!("serviceWorker" in navigator)) return Promise.reject(new Error("SW unsupported"));

  const swSource = `
    const CACHE = "peace-lab-auto-v1";
    const CORE = ["./","./index.html"]; // your server should serve index.html at "/peace/lab/"
    self.addEventListener("install", e=>{
      e.waitUntil(caches.open(CACHE).then(c=>c.addAll(CORE)));
      self.skipWaiting();
    });
    self.addEventListener("activate", e=>{
      e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))));
      self.clients.claim();
    });
    self.addEventListener("fetch", e=>{
      const u = new URL(e.request.url);
      if(u.origin === location.origin){
        e.respondWith((async()=>{
          const cache = await caches.open(CACHE);
          const cached = await cache.match(e.request);
          try{
            const net = await fetch(e.request);
            cache.put(e.request, net.clone());
            return net;
          }catch{
            return cached || new Response("Offline", {status:200, headers:{"Content-Type":"text/plain"}});
          }
        })());
      }
    });
  `;

  try{
    const blob = new Blob([swSource], {type:"text/javascript"});
    const swUrl = URL.createObjectURL(blob);
    return navigator.serviceWorker.register(swUrl, {scope:"./"})
      .then(r=>{ console.log("SW registered (blob)"); return r; })
      .catch(err=>{
        console.warn("Inline SW registration failed; continuing without caching.", err);
        throw err;
      });
  }catch(err){
    console.warn("Inline SW creation failed; continuing without caching.", err);
    return Promise.reject(err);
  }
}

/* Boot */
renderFeeds();
renderCookbook();
startTimer();
statusEl.textContent = "Ready. Configure feeds, set auto-scan, and leave this tab open.";

/* Try to register the inline SW; if it fails, we keep going. */
registerInlineServiceWorker()
  .then(()=>{ document.getElementById("offline").textContent = "Offline caching ready"; })
  .catch(()=>{ document.getElementById("offline").textContent = "Inline SW not available (UI still works)"; });

/* “Install” helper — single-file edition */
document.getElementById("install").addEventListener("click", ()=>{
  alert("Use your browser’s Add to Home Screen. Inline SW may be blocked by your browser; app still runs.");
});
</script>
</body>
</html>
